FROM debian:bullseye-slim

WORKDIR /usr/src/app

COPY ./source/navitiacommon ./navitiacommon
COPY ./source/tyr ./tyr
COPY ./docker/ca-certificates/*.crt /usr/local/share/ca-certificates/
COPY ./docker/run_tyr_beat.sh ./run.sh

RUN apt-get update --fix-missing \
    && apt-get install -y curl libpq5 python3.9-dev python3-pip git ca-certificates \
    && update-ca-certificates \
    && (cd navitiacommon && python3 setup.py install) \
    && (cd tyr && python3 setup.py install && pip3 install --no-cache-dir -U -r requirements.txt)\
    && rm -rf navitiacommon tyr \
    && apt-get purge -y \
        python3-pip \
        git \
    && apt-get autoremove -y




ENTRYPOINT [ "/usr/src/app/run.sh" ]
